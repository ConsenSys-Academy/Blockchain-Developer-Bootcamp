<!DOCTYPE html>
<html>
  <head>
    <title>Index - ConsenSys Academy Developer Bootcamp</title>
    <link href="../../../style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js" async></script>
    <script src="../../../text-bounce.js" async></script>
  </head>
  <body>
    <h1 id="optimizing-gas">Optimizing Gas</h1>
<p>Reducing the gas consumed by a contract is important in two situations:</p>
<ul>
<li>Cost of deploying a contract</li>
<li>Cost to call the contract functions</li>
</ul>
<p><a href="https://solidity.readthedocs.io/en/v0.7.1/internals/optimiser.html" target="_blank">The Solidity optimizer</a> tries to improve the efficiency of your contract as much as possible during compile time. Feel free to dig into the internals of the optimizer.</p>
<p>One of the best ways to optimize your contracts gas usage is to reduce expensive operations in the contract's functions. Creating and modifying storage variables can be expensive.</p>
<p>20,000 gas when a value is set to non-zero from zero; 5,000 gas when writing to existing storage or setting a value to zero; and a 15,000 gas refund when a non-zero value is set to zero.</p>
<p><a href="https://docs.google.com/spreadsheets/d/1n6mRqkBz3iWcOlRem_mO09GtSKEKrAsfO7Frgx18pNU/edit#gid=0" target="_blank">Here is a list of OPCODES and their gas costs.</a></p>
<h2 id="short-circuit-rules">Short Circuit Rules</h2>
<p>The operators <code>||</code> and <code>&amp;&amp;</code> apply the common short-circuiting rules. This means that in the expression <code>f(x) || g(y)</code>, if <code>f(x)</code> evaluates to true, <code>g(y)</code> will not be evaluated even if it may have side-effects.</p>
<p>How can these functions in <a href="https://gist.github.com/ConsenSys-Academy/a61670fd8796d73d8b4b7d5935f9e714" target="_blank">Unoptimized.sol</a> be modified to reduce gas usage?</p>
<div class="codehilite"><pre><span></span><code><span class="nv">function</span><span class="w"> </span><span class="nv">shortCircuit</span><span class="ss">()</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="nv">returns</span><span class="ss">(</span><span class="nv">bool</span><span class="ss">)</span>{<span class="w">      </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">oftenFalse</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">oftenTrue</span><span class="ss">)</span><span class="w"> </span>{<span class="w">          </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">true</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w"> </span>
}<span class="w">    </span>

<span class="nv">function</span><span class="w"> </span><span class="nv">shortCircuit2</span><span class="ss">()</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="nv">returns</span><span class="ss">(</span><span class="nv">bool</span><span class="ss">)</span>{<span class="w">      </span>
<span class="w">  </span><span class="k">if</span><span class="ss">(</span><span class="nv">oftenTrue</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">oftenFalse</span><span class="ss">)</span><span class="w"> </span>{<span class="w">          </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">false</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{<span class="w">          </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">true</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w">  </span>
}<span class="w">  </span>
</code></pre></div>

<h2 id="expensive-operations-in-a-loop">Expensive operations in a loop</h2>
<p>Modifying storage variables in a loop can be very expensive and should be avoided unless absolutely necessary.</p>
<p>How can this function be improved, given that <code>loops</code> is a storage variable? <a href="https://gist.github.com/ConsenSys-Academy/a61670fd8796d73d8b4b7d5935f9e714#file-unoptimized-sol-L26" target="_blank">Here is the source file.</a></p>
<div class="codehilite"><pre><span></span><code><span class="nv">function</span><span class="w"> </span><span class="nv">looping</span><span class="w"> </span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">x</span><span class="ss">)</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">returns</span><span class="w"> </span><span class="ss">(</span><span class="nv">bool</span><span class="ss">)</span><span class="w"> </span>{<span class="w">      </span>
<span class="w">  </span><span class="k">for</span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">i</span><span class="c1">; i &lt; x; i++){          </span><span class="w"></span>
<span class="w">    </span><span class="nv">loops</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w">     </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nv">true</span><span class="c1">;  </span><span class="w"></span>
}<span class="w">  </span>
</code></pre></div>

<h2 id="reduce-the-number-of-loops">Reduce the number of loops</h2>
<p>Zero loops is ideal, but sometimes you just have to loop. Since loops are expensive, can you reduce the number of loops in your functions?</p>
<div class="codehilite"><pre><span></span><code><span class="nv">function</span><span class="w"> </span><span class="nv">looping2</span><span class="w"> </span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">x</span><span class="ss">)</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">pure</span><span class="w"> </span><span class="nv">returns</span><span class="ss">(</span><span class="nv">bool</span><span class="ss">)</span>{<span class="w">      </span>
<span class="w">  </span><span class="nv">uint</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span><span class="nv">uint</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; i &lt; x; i++){          </span><span class="w"></span>
<span class="w">    </span><span class="nv">m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">i</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w">      </span>
<span class="w">  </span><span class="k">for</span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; j &lt; x; j++){          </span><span class="w"></span>
<span class="w">    </span><span class="nv">v</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nv">j</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span>}<span class="w">      </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nv">true</span><span class="c1">;  </span><span class="w"></span>
}<span class="w">  </span>
</code></pre></div>

<h2 id="fixed-size-byte-arrays">Fixed size byte arrays</h2>
<p><a href="https://solidity.readthedocs.io/en/latest/types.html#fixed-size-byte-arrays" target="_blank">From the Solidity Docs:</a></p>
<p>It is possible to use an array of bytes as <code>byte[]</code>, but it is wasting a lot of space, 31 bytes every element, to be exact, when passing in calls. It is better to use <code>bytes</code>. As a rule of thumb, use <code>bytes</code> for arbitrary-length raw byte data and <code>string</code> for arbitrary-length string (UTF-8) data. If you can limit the length to a certain number of bytes, always use one of <code>bytes1</code> to <code>bytes32</code> because they are much cheaper.</p>
<p>How can this function be optimized?</p>
<div class="codehilite"><pre><span></span><code><span class="nv">function</span><span class="w"> </span><span class="nv">byteArray</span><span class="ss">()</span><span class="w"> </span><span class="nv">public</span><span class="w"> </span><span class="nv">returns</span><span class="ss">(</span><span class="nv">uint</span><span class="ss">)</span>{<span class="w">      </span>
<span class="w">  </span><span class="nv">byte</span>[]<span class="w"> </span><span class="nv">byteArray</span><span class="c1">;      </span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nv">gasleft</span><span class="ss">()</span><span class="c1">;  </span><span class="w"></span>
}<span class="w">  </span>
</code></pre></div>

<p>Additional Resources:</p>
<ul>
<li><a href="https://medium.com/coinmonks/optimizing-your-solidity-contracts-gas-usage-9d65334db6c7" target="_blank">Optimizing Solidity contract's gas usage</a></li>
<li><a href="https://arxiv.org/pdf/1703.03994.pdf" target="_blank">Under Optimized Smart Contracts Devour Your Money</a></li>
<li><a href="https://medium.com/better-programming/how-to-write-smart-contracts-that-optimize-gas-spent-on-ethereum-30b5e9c5db85" target="_blank">How to Write Smart Contracts that Optimize Gas</a></li>
</ul>
    <br /><div class="footer">
    <a href="https://github.com/ConsenSys-Academy/Blockchain-Developer-Bootcamp/edit/staging/docs/S03-smart-contracts/M4-design-patterns/L9-optimizing-gas/index.md" target="_blank">Edit this page on GitHub</a>
    
    <div class="discord">
        <img class="discord-logo" src="../../../discord.svg" alt="Discord logo" ><a href="https://discord.gg/FrHSjSn9dX" target="_blank" >Questions? Ask on Discord! </a>  
    </div> 
</div>
  </body>
</html>